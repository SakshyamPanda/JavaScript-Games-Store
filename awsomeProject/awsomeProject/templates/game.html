{% extends "base.html" %}

{% block main %}
<script>
  window.addEventListener("message", receiveMessage, false);

  function receiveMessage(event)
  {
    var origin = event.origin || event.originalEvent.origin; // For Chrome, the origin property is in the event.originalEvent object.
    //if (origin !== "http://example.org:8080")
    //  return;
    if (event.data.messageType == "SAVE"){
      var requestData = { 'game': {{ game.pk }} , 'score': event.data.gameState['score'], 'items': event.data.gameState['playerItems']};
      $.ajax({
          type: "POST",
          url: "saveGame/",
          data: requestData,
          //contentType: 'application/json',
          success: function(data){
              alert(data);
          },
          error: function(msg){
              alert( "There is an error with the server." );
          }
      });
    }
    if (event.data.messageType == "LOAD_REQUEST"){
      var requestData = { 'game': {{ game.pk }}};
      $.ajax({
          type: "POST",
          url: "loadGame/",
          data: requestData,
          success: function(data){

              if ( data.messageType == "LOAD"){
                var message = data;
                var iframe = document.getElementById("game").contentWindow;
                iframe.postMessage(message, "{{ game.url }}");
              }
              else
                alert(data);
          },
          error: function(msg){
              alert( "There is an error with the server." );
          }
      });
    }
    if(event.data.messageType == "SCORE"){
      var requestData ={ 'game': {{ game.pk }} , 'score': event.data.score};
      $.ajax({
          type: "POST",
          url: "saveScore/",
          data: requestData,
          //contentType: 'application/json',
          success: function(data){
              //TODO: dont reload whole page, make it like a AJAX call to refresh highscores only
                alert(data);
                location.reload();
          },
          error: function(msg){
              alert( "There is an error with the server." );
          }
      });
    }

  }
</script>

<h1> {{ game.name }} </h1>
<div class="col-sm-6">
  {% if gameBought %}
  <iframe src="{{ game.url }}" name="game" id="game"></iframe>
  {% else %}
  <p> You dont own the GAME!!!!!! Buy it <a href="{% url 'buyGame' game.name %}"> here </a> </p>
  {% endif %}
</div>
<div class="col-sm-6" id="highScores">
  <h1> High Scores </h1>
  <!-- Please style this table in CSS -->
  <table border="6">
    <tr>
        <th>User</th>
        <th>Score</th>
    </tr>
    {% for item in scores %}
    <tr>
        <td>{{ item.user }}</td>
        <td>{{ item.score }}</td>
    </tr>
    {% endfor %}
  </table>
</div>

{% endblock %}
